name: Deploy Production

on:
  workflow_run:
    workflows:
      - CI
    types:
      - completed

permissions:
  contents: read

concurrency:
  group: prod-deploy
  cancel-in-progress: true

jobs:
  deploy:
    name: deploy-production
    if: >
      ${{
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.head_branch == 'main'
      }}
    runs-on: ubuntu-latest
    environment: production
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      FLY_APP_NAME: ${{ vars.FLY_APP_NAME }}
    steps:
      - name: Checkout triggering main commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Validate required Fly.io secret
        run: test -n "$FLY_API_TOKEN"

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Resolve Fly app slug
        id: resolve-fly-app
        run: |
          if [ -n "$FLY_APP_NAME" ]; then
            APP="$FLY_APP_NAME"
          else
            APP="$(sed -nE 's/^app[[:space:]]*=[[:space:]]*"([^"]+)".*/\1/p' fly.toml | head -n1)"
          fi

          if [ -z "$APP" ]; then
            echo "::error::No Fly app slug found. Set vars.FLY_APP_NAME or define app in fly.toml."
            exit 1
          fi

          echo "app=$APP" >> "$GITHUB_OUTPUT"

      - name: Validate Fly app access
        run: |
          APP="${{ steps.resolve-fly-app.outputs.app }}"
          if ! flyctl status --app "$APP" >/dev/null 2>&1; then
            echo "::error::Fly app '$APP' was not found or is not accessible by this token."
            echo "::error::Set GitHub variable FLY_APP_NAME to your real Fly app slug (for example, 'data-ghost') or update fly.toml."
            exit 1
          fi

      - name: Deploy to Fly.io production
        run: flyctl deploy --remote-only --config fly.toml --app "${{ steps.resolve-fly-app.outputs.app }}"
